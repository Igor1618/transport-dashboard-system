<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дашборд Транспортной Компании</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #1f2937;
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .month-selector select, .search-input {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .month-selector select:hover, .search-input:hover {
            border-color: #667eea;
        }

        .month-selector select:focus, .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-input {
            width: 250px;
        }

        .kpi-row {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
        }

        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            color: white;
        }

        .kpi-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .kpi-label {
            font-size: 11px;
            opacity: 0.9;
        }

        .content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .block {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .block-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead {
            position: sticky;
            top: 0;
            background: #f9fafb;
            z-index: 10;
        }

        th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 2px solid #e5e7eb;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            color: #667eea;
        }

        td {
            padding: 12px 8px;
            border-bottom: 1px solid #f3f4f6;
        }

        tbody tr {
            cursor: pointer;
            transition: all 0.2s;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        .vehicle-number {
            font-weight: 600;
            color: #1f2937;
        }

        .vehicle-model {
            color: #6b7280;
            font-size: 11px;
        }

        .value-positive {
            color: #10b981;
            font-weight: 600;
        }

        .value-negative {
            color: #ef4444;
            font-weight: 600;
        }

        .efficiency-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .efficiency-mini-bar {
            flex: 1;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }

        .efficiency-mini-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .sort-icon {
            display: inline-block;
            margin-left: 5px;
            opacity: 0.3;
        }

        .sort-icon.active {
            opacity: 1;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-close {
            cursor: pointer;
            font-size: 24px;
            color: #6b7280;
        }

        .modal-close:hover {
            color: #1f2937;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .detail-card {
            background: #f9fafb;
            border-radius: 10px;
            padding: 15px;
        }

        .detail-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 15px;
        }

        .top-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .top-item {
            background: #f9fafb;
            border-radius: 10px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-rank {
            font-size: 20px;
            margin-right: 10px;
        }

        .top-info {
            flex: 1;
        }

        .top-number {
            font-weight: 600;
            font-size: 14px;
        }

        .top-model {
            font-size: 11px;
            color: #6b7280;
        }

        .top-value {
            font-weight: 700;
            font-size: 16px;
            color: #10b981;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: #667eea;
        }

        .filter-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <div class="header-top">
                <div class="header-title">Дашборд Транспортной Компании</div>
                <div class="header-controls">
                    <input type="text" id="searchInput" class="search-input" placeholder="Поиск по номеру или модели...">
                    <div class="month-selector">
                        <select id="monthSelect" onchange="updateDashboard()">
                            <option value="0">Январь 2025</option>
                            <option value="1">Февраль 2025</option>
                            <option value="2">Март 2025</option>
                            <option value="3">Апрель 2025</option>
                            <option value="4">Май 2025</option>
                            <option value="5" selected>Июнь 2025</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="kpi-row">
                <div class="kpi-card">
                    <div class="kpi-value" id="kpiRevenue">0 ₽</div>
                    <div class="kpi-label">Выручка</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpiExpenses">0 ₽</div>
                    <div class="kpi-label">Расходы</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpiProfit">0 ₽</div>
                    <div class="kpi-label">Прибыль</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpiMargin">0%</div>
                    <div class="kpi-label">Маржа</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpiVehicles">0</div>
                    <div class="kpi-label">Машин</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpiTrips">0</div>
                    <div class="kpi-label">Рейсов</div>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="block">
                <div class="block-title">
                    <span>Транспорт</span>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterTable('all')">Все</button>
                        <button class="filter-btn" onclick="filterTable('profitable')">Прибыльные</button>
                        <button class="filter-btn" onclick="filterTable('problematic')">Проблемные</button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="vehicleTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('number')">Номер <span class="sort-icon">↕</span></th>
                                <th onclick="sortTable('model')">Модель <span class="sort-icon">↕</span></th>
                                <th onclick="sortTable('income')">Доход <span class="sort-icon">↕</span></th>
                                <th onclick="sortTable('expenses')">Расход <span class="sort-icon">↕</span></th>
                                <th onclick="sortTable('profit')">Прибыль <span class="sort-icon">↕</span></th>
                                <th onclick="sortTable('efficiency')">Эффективность <span class="sort-icon">↕</span></th>
                                <th onclick="sortTable('trips')">Рейсов <span class="sort-icon">↕</span></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>

            <div>
                <div class="block" style="margin-bottom: 20px;">
                    <div class="block-title">Топ-5 по прибыли</div>
                    <div class="top-list" id="topList"></div>
                </div>
                <div class="block">
                    <div class="block-title">График прибыли</div>
                    <div class="chart-container">
                        <canvas id="profitChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="vehicleModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle"></div>
                <div class="modal-close" onclick="closeModal()">×</div>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // Генерация данных для 50 машин
        const vehicleData = {};
        const numbers = ['Н678МН78', 'М345КЛ77', 'К012ИЙ50', 'Е789ЖЗ99', 'В456ГД78'];
        const models = ['MAN TGX', 'Mercedes Actros', 'Scania R500', 'Volvo FH', 'DAF XF', 'Iveco Stralis'];
        
        for (let i = 0; i < 50; i++) {
            const randomNum = `${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${Math.floor(100 + Math.random() * 900)}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${Math.floor(10 + Math.random() * 90)}`;
            const model = models[Math.floor(Math.random() * models.length)];
            
            vehicleData[randomNum] = {
                model: model,
                monthlyData: []
            };
            
            for (let month = 0; month < 6; month++) {
                const baseIncome = 350000 + Math.random() * 150000;
                const baseExpenses = baseIncome * (0.35 + Math.random() * 0.25);
                vehicleData[randomNum].monthlyData.push({
                    income: Math.round(baseIncome),
                    expenses: Math.round(baseExpenses),
                    efficiency: Math.round(60 + Math.random() * 30),
                    trips: Math.round(18 + Math.random() * 12)
                });
            }
        }

        let currentMonth = 5;
        let sortField = 'profit';
        let sortDirection = 'desc';
        let currentFilter = 'all';
        let profitChart;

        function formatNumber(num) {
            return num.toLocaleString('ru-RU') + ' ₽';
        }

        function updateDashboard() {
            currentMonth = parseInt(document.getElementById('monthSelect').value);
            updateKPI();
            updateTable();
            updateTopList();
            updateChart();
        }

        function updateKPI() {
            let totalIncome = 0, totalExpenses = 0, totalTrips = 0;
            
            Object.keys(vehicleData).forEach(num => {
                const data = vehicleData[num].monthlyData[currentMonth];
                totalIncome += data.income;
                totalExpenses += data.expenses;
                totalTrips += data.trips;
            });
            
            const totalProfit = totalIncome - totalExpenses;
            const margin = ((totalProfit / totalIncome) * 100).toFixed(1);
            
            document.getElementById('kpiRevenue').textContent = formatNumber(totalIncome);
            document.getElementById('kpiExpenses').textContent = formatNumber(totalExpenses);
            document.getElementById('kpiProfit').textContent = formatNumber(totalProfit);
            document.getElementById('kpiMargin').textContent = margin + '%';
            document.getElementById('kpiVehicles').textContent = Object.keys(vehicleData).length;
            document.getElementById('kpiTrips').textContent = totalTrips;
        }

        function updateTable() {
            const tbody = document.getElementById('tableBody');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let vehicles = Object.keys(vehicleData).map(num => {
                const data = vehicleData[num].monthlyData[currentMonth];
                return {
                    number: num,
                    model: vehicleData[num].model,
                    income: data.income,
                    expenses: data.expenses,
                    profit: data.income - data.expenses,
                    efficiency: data.efficiency,
                    trips: data.trips
                };
            });

            // Фильтрация
            if (searchTerm) {
                vehicles = vehicles.filter(v => 
                    v.number.toLowerCase().includes(searchTerm) || 
                    v.model.toLowerCase().includes(searchTerm)
                );
            }

            if (currentFilter === 'profitable') {
                vehicles = vehicles.filter(v => v.profit > 100000);
            } else if (currentFilter === 'problematic') {
                vehicles = vehicles.filter(v => v.efficiency < 70);
            }

            // Сортировка
            vehicles.sort((a, b) => {
                const aVal = a[sortField];
                const bVal = b[sortField];
                return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            });

            tbody.innerHTML = vehicles.map(v => `
                <tr onclick="showModal('${v.number}')">
                    <td><div class="vehicle-number">${v.number}</div></td>
                    <td><div class="vehicle-model">${v.model}</div></td>
                    <td>${formatNumber(v.income)}</td>
                    <td>${formatNumber(v.expenses)}</td>
                    <td class="${v.profit > 0 ? 'value-positive' : 'value-negative'}">${formatNumber(v.profit)}</td>
                    <td>
                        <div class="efficiency-cell">
                            <span>${v.efficiency}%</span>
                            <div class="efficiency-mini-bar">
                                <div class="efficiency-mini-fill" style="width: ${v.efficiency}%"></div>
                            </div>
                        </div>
                    </td>
                    <td>${v.trips}</td>
                </tr>
            `).join('');
        }

        function updateTopList() {
            const vehicles = Object.keys(vehicleData).map(num => {
                const data = vehicleData[num].monthlyData[currentMonth];
                return {
                    number: num,
                    model: vehicleData[num].model,
                    profit: data.income - data.expenses
                };
            }).sort((a, b) => b.profit - a.profit).slice(0, 5);

            const ranks = ['🥇', '🥈', '🥉', '4️⃣', '5️⃣'];
            document.getElementById('topList').innerHTML = vehicles.map((v, i) => `
                <div class="top-item">
                    <span class="top-rank">${ranks[i]}</span>
                    <div class="top-info">
                        <div class="top-number">${v.number}</div>
                        <div class="top-model">${v.model}</div>
                    </div>
                    <div class="top-value">${formatNumber(v.profit)}</div>
                </div>
            `).join('');
        }

        function updateChart() {
            const profitData = [];
            for (let i = 0; i <= currentMonth; i++) {
                let total = 0;
                Object.keys(vehicleData).forEach(num => {
                    const data = vehicleData[num].monthlyData[i];
                    total += (data.income - data.expenses);
                });
                profitData.push(total);
            }
            
            profitChart.data.datasets[0].data = profitData;
            profitChart.update();
        }

        function sortTable(field) {
            if (sortField === field) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'desc';
            }
            updateTable();
        }

        function filterTable(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateTable();
        }

        function showModal(vehicleNum) {
            const vehicle = vehicleData[vehicleNum];
            const data = vehicle.monthlyData[currentMonth];
            const profit = data.income - data.expenses;
            
            document.getElementById('modalTitle').textContent = `${vehicleNum} - ${vehicle.model}`;
            document.getElementById('modalBody').innerHTML = `
                <div class="detail-grid">
                    <div class="detail-card">
                        <div class="detail-label">Доход</div>
                        <div class="detail-value" style="color: #10b981;">${formatNumber(data.income)}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Расход</div>
                        <div class="detail-value" style="color: #ef4444;">${formatNumber(data.expenses)}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Прибыль</div>
                        <div class="detail-value">${formatNumber(profit)}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Эффективность</div>
                        <div class="detail-value">${data.efficiency}%</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Рейсов</div>
                        <div class="detail-value">${data.trips}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Маржа</div>
                        <div class="detail-value">${((profit / data.income) * 100).toFixed(1)}%</div>
                    </div>
                </div>
            `;
            document.getElementById('vehicleModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('vehicleModal').classList.remove('active');
        }

        document.getElementById('searchInput').addEventListener('input', updateTable);

        window.addEventListener('load', () => {
            const ctx = document.getElementById('profitChart').getContext('2d');
            profitChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн'],
                    datasets: [{
                        label: 'Прибыль',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { ticks: { color: '#6b7280' }, grid: { color: '#f3f4f6' } },
                        x: { ticks: { color: '#6b7280' }, grid: { color: '#f3f4f6' } }
                    }
                }
            });

            updateDashboard();
        });
    </script>
</body>
</html>
