<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дашборд Транспортной Компании</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #1f2937;
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .month-selector select, .search-input {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .month-selector select:hover, .search-input:hover {
            border-color: #667eea;
        }

        .month-selector select:focus, .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-input {
            width: 250px;
        }

        .kpi-row {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
        }

        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            color: white;
        }

        .kpi-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .kpi-label {
            font-size: 11px;
            opacity: 0.9;
        }

        .content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .block {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .block-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .error {
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 8px;
            padding: 15px;
            color: #c33;
            margin: 10px 0;
        }

        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead {
            position: sticky;
            top: 0;
            background: #f9fafb;
            z-index: 10;
        }

        th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 2px solid #e5e7eb;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            color: #667eea;
        }

        td {
            padding: 12px 8px;
            border-bottom: 1px solid #f3f4f6;
        }

        tbody tr {
            cursor: pointer;
            transition: all 0.2s;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        .vehicle-number {
            font-weight: 600;
            color: #1f2937;
        }

        .vehicle-model {
            color: #6b7280;
            font-size: 11px;
        }

        .value-positive {
            color: #10b981;
            font-weight: 600;
        }

        .value-negative {
            color: #ef4444;
            font-weight: 600;
        }

        .efficiency-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .efficiency-mini-bar {
            flex: 1;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }

        .efficiency-mini-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-close {
            cursor: pointer;
            font-size: 24px;
            color: #6b7280;
        }

        .modal-close:hover {
            color: #1f2937;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .detail-card {
            background: #f9fafb;
            border-radius: 10px;
            padding: 15px;
        }

        .detail-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
        }

        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 15px;
        }

        .top-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .top-item {
            background: #f9fafb;
            border-radius: 10px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-rank {
            font-size: 20px;
            margin-right: 10px;
        }

        .top-info {
            flex: 1;
        }

        .top-number {
            font-weight: 600;
            font-size: 14px;
        }

        .top-model {
            font-size: 11px;
            color: #6b7280;
        }

        .top-value {
            font-weight: 700;
            font-size: 16px;
            color: #10b981;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: #667eea;
        }

        .filter-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <div class="header-top">
                <div class="header-title">Дашборд Транспортной Компании</div>
                <div class="header-controls">
                    <input type="text" id="searchInput" class="search-input" placeholder="Поиск по номеру или модели...">
                    <div class="month-selector">
                        <select id="monthSelect" onchange="updateDashboard()">
                            <option value="0">Январь 2025</option>
                            <option value="1">Февраль 2025</option>
                            <option value="2">Март 2025</option>
                            <option value="3">Апрель 2025</option>
                            <option value="4">Май 2025</option>
                            <option value="5">Июнь 2025</option>
                            <option value="6">Июль 2025</option>
                            <option value="7">Август 2025</option>
                            <option value="8">Сентябрь 2025</option>
                            <option value="9" selected>Октябрь 2025</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="kpi-row">
                <div class="kpi-card">
                    <div class="kpi-value" id="kpiRevenue">0 ₽</div>
                    <div class="kpi-label">Выручка</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpiExpenses">0 ₽</div>
                    <div class="kpi-label">Расходы</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpiProfit">0 ₽</div>
                    <div class="kpi-label">Прибыль</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpiMargin">0%</div>
                    <div class="kpi-label">Маржа</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpiVehicles">0</div>
                    <div class="kpi-label">Машин</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpiTrips">0</div>
                    <div class="kpi-label">Рейсов</div>
                </div>
            </div>
        </div>

        <div id="errorContainer"></div>

        <div class="content">
            <div class="block">
                <div class="block-title">
                    <span>Транспорт</span>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterTable('all')">Все</button>
                        <button class="filter-btn" onclick="filterTable('profitable')">Прибыльные</button>
                        <button class="filter-btn" onclick="filterTable('problematic')">Проблемные</button>
                    </div>
                </div>
                <div id="tableLoading" class="loading">Загрузка данных...</div>
                <div class="table-container" style="display:none;" id="tableContainer">
                    <table id="vehicleTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('number')">Номер</th>
                                <th onclick="sortTable('model')">Модель</th>
                                <th onclick="sortTable('income')">Доход</th>
                                <th onclick="sortTable('expenses')">Расход</th>
                                <th onclick="sortTable('profit')">Прибыль</th>
                                <th onclick="sortTable('efficiency')">Эффективность</th>
                                <th onclick="sortTable('trips')">Рейсов</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>

            <div>
                <div class="block" style="margin-bottom: 20px;">
                    <div class="block-title">Топ-5 по прибыли</div>
                    <div class="top-list" id="topList">
                        <div class="loading">Загрузка...</div>
                    </div>
                </div>
                <div class="block">
                    <div class="block-title">График прибыли</div>
                    <div class="chart-container">
                        <canvas id="profitChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="vehicleModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle"></div>
                <div class="modal-close" onclick="closeModal()">×</div>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // НАСТРОЙКИ SUPABASE
        const SUPABASE_URL = 'http://195.26.226.37:8000';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiJ9.LGzLagUWLYU030_PrhQdahdHGhALq6agEyzf3KH3bI0';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentMonth = 9; // Октябрь
        let currentYear = 2025;
        let sortField = 'profit';
        let sortDirection = 'desc';
        let currentFilter = 'all';
        let profitChart;
        let vehiclesData = [];

        function formatNumber(num) {
            return Math.round(num).toLocaleString('ru-RU') + ' ₽';
        }

        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="error">${message}</div>`;
        }

        async function loadVehiclesData() {
            try {
                document.getElementById('tableLoading').style.display = 'block';
                document.getElementById('tableContainer').style.display = 'none';

                // Загружаем данные машин с их месячными показателями
                const { data: vehicles, error: vError } = await supabase
                    .from('vehicles')
                    .select(`
                        *,
                        vehicle_monthly_data (
                            year,
                            month,
                            income,
                            expenses,
                            trips,
                            efficiency
                        )
                    `);

                if (vError) throw vError;

                vehiclesData = vehicles.map(v => {
                    const monthData = v.vehicle_monthly_data.find(
                        m => m.year === currentYear && m.month === (currentMonth + 1)
                    ) || { income: 0, expenses: 0, trips: 0, efficiency: 0 };

                    return {
                        id: v.id,
                        number: v.number,
                        model: v.model,
                        income: monthData.income || 0,
                        expenses: monthData.expenses || 0,
                        trips: monthData.trips || 0,
                        efficiency: monthData.efficiency || 0,
                        profit: (monthData.income || 0) - (monthData.expenses || 0)
                    };
                });

                document.getElementById('tableLoading').style.display = 'none';
                document.getElementById('tableContainer').style.display = 'block';
                
                updateDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Ошибка загрузки данных: ' + error.message);
                document.getElementById('tableLoading').textContent = 'Ошибка загрузки';
            }
        }

        function updateDashboard() {
            currentMonth = parseInt(document.getElementById('monthSelect').value);
            loadVehiclesData();
        }

        function updateKPI() {
            let totalIncome = 0, totalExpenses = 0, totalTrips = 0;
            
            vehiclesData.forEach(v => {
                totalIncome += v.income;
                totalExpenses += v.expenses;
                totalTrips += v.trips;
            });
            
            const totalProfit = totalIncome - totalExpenses;
            const margin = totalIncome > 0 ? ((totalProfit / totalIncome) * 100).toFixed(1) : 0;
            
            document.getElementById('kpiRevenue').textContent = formatNumber(totalIncome);
            document.getElementById('kpiExpenses').textContent = formatNumber(totalExpenses);
            document.getElementById('kpiProfit').textContent = formatNumber(totalProfit);
            document.getElementById('kpiMargin').textContent = margin + '%';
            document.getElementById('kpiVehicles').textContent = vehiclesData.length;
            document.getElementById('kpiTrips').textContent = totalTrips;
        }

        function updateTable() {
            const tbody = document.getElementById('tableBody');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let vehicles = [...vehiclesData];

            if (searchTerm) {
                vehicles = vehicles.filter(v => 
                    v.number.toLowerCase().includes(searchTerm) || 
                    v.model.toLowerCase().includes(searchTerm)
                );
            }

            if (currentFilter === 'profitable') {
                vehicles = vehicles.filter(v => v.profit > 100000);
            } else if (currentFilter === 'problematic') {
                vehicles = vehicles.filter(v => v.efficiency < 70);
            }

            vehicles.sort((a, b) => {
                const aVal = a[sortField];
                const bVal = b[sortField];
                return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            });

            tbody.innerHTML = vehicles.map(v => `
                <tr onclick="showModal('${v.id}')">
                    <td><div class="vehicle-number">${v.number}</div></td>
                    <td><div class="vehicle-model">${v.model}</div></td>
                    <td>${formatNumber(v.income)}</td>
                    <td>${formatNumber(v.expenses)}</td>
                    <td class="${v.profit > 0 ? 'value-positive' : 'value-negative'}">${formatNumber(v.profit)}</td>
                    <td>
                        <div class="efficiency-cell">
                            <span>${v.efficiency}%</span>
                            <div class="efficiency-mini-bar">
                                <div class="efficiency-mini-fill" style="width: ${v.efficiency}%"></div>
                            </div>
                        </div>
                    </td>
                    <td>${v.trips}</td>
                </tr>
            `).join('');

            updateKPI();
            updateTopList();
        }

        function updateTopList() {
            const vehicles = [...vehiclesData]
                .sort((a, b) => b.profit - a.profit)
                .slice(0, 5);

            const ranks = ['🥇', '🥈', '🥉', '4️⃣', '5️⃣'];
            document.getElementById('topList').innerHTML = vehicles.map((v, i) => `
                <div class="top-item">
                    <span class="top-rank">${ranks[i]}</span>
                    <div class="top-info">
                        <div class="top-number">${v.number}</div>
                        <div class="top-model">${v.model}</div>
                    </div>
                    <div class="top-value">${formatNumber(v.profit)}</div>
                </div>
            `).join('');
        }

        function sortTable(field) {
            if (sortField === field) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'desc';
            }
            updateTable();
        }

        function filterTable(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateTable();
        }

        function showModal(vehicleId) {
            const vehicle = vehiclesData.find(v => v.id === vehicleId);
            if (!vehicle) return;
            
            document.getElementById('modalTitle').textContent = `${vehicle.number} - ${vehicle.model}`;
            document.getElementById('modalBody').innerHTML = `
                <div class="detail-grid">
                    <div class="detail-card">
                        <div class="detail-label">Доход</div>
                        <div class="detail-value" style="color: #10b981;">${formatNumber(vehicle.income)}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Расход</div>
                        <div class="detail-value" style="color: #ef4444;">${formatNumber(vehicle.expenses)}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Прибыль</div>
                        <div class="detail-value">${formatNumber(vehicle.profit)}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Эффективность</div>
                        <div class="detail-value">${vehicle.efficiency}%</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Рейсов</div>
                        <div class="detail-value">${vehicle.trips}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Маржа</div>
                        <div class="detail-value">${vehicle.income > 0 ? ((vehicle.profit / vehicle.income) * 100).toFixed(1) : 0}%</div>
                    </div>
                </div>
            `;
            document.getElementById('vehicleModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('vehicleModal').classList.remove('active');
        }

        document.getElementById('searchInput').addEventListener('input', updateTable);

        window.addEventListener('load', () => {
            const ctx = document.getElementById('profitChart').getContext('2d');
            profitChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн', 'Июл', 'Авг', 'Сен', 'Окт'],
                    datasets: [{
                        label: 'Прибыль',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { ticks: { color: '#6b7280' }, grid: { color: '#f3f4f6' } },
                        x: { ticks: { color: '#6b7280' }, grid: { color: '#f3f4f6' } }
                    }
                }
            });

            loadVehiclesData();
        });
    </script>
</body>
</html>
