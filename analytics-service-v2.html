<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics & Insights Service v2.1</title>
    <style>
        :root {
            --primary-blue: #2563eb;
            --success-green: #10b981;
            --warning-orange: #f59e0b;
            --danger-red: #ef4444;
            --neutral-gray: #6b7280;
            --background: #f8fafc;
            --card-bg: #ffffff;
            --border: #e5e7eb;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            margin: 0;
            padding: 16px;
            min-height: calc(100vh - 32px);
        }

        .analytics-container {
            display: grid;
            grid-template-rows: auto 1fr auto;
            gap: 16px;
            height: calc(100vh - 32px);
        }

        .insights-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .insight-card {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 8px;
            padding: 16px;
            border-left: 4px solid var(--primary-blue);
            transition: transform 0.2s ease;
        }

        .insight-card:hover {
            transform: translateY(-2px);
        }

        .insight-card.success { border-left-color: var(--success-green); }
        .insight-card.warning { border-left-color: var(--warning-orange); }
        .insight-card.danger { border-left-color: var(--danger-red); }

        .insight-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .recommendations-list {
            display: grid;
            gap: 12px;
        }

        .recommendation-item {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid var(--border);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            transition: all 0.2s ease;
        }

        .recommendation-item:hover {
            box-shadow: var(--shadow);
            transform: translateX(4px);
        }

        .recommendation-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .recommendation-icon.maintenance { background: #fef3c7; color: #d97706; }
        .recommendation-icon.optimization { background: #dcfce7; color: #16a34a; }
        .recommendation-icon.training { background: #dbeafe; color: #2563eb; }
        .recommendation-icon.monitoring { background: #f3e8ff; color: #9333ea; }

        .recommendation-content {
            flex: 1;
        }

        .recommendation-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .recommendation-description {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .alerts-list {
            display: grid;
            gap: 8px;
        }

        .alert-item {
            padding: 12px 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .alert-item.critical {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .alert-item.warning {
            background: #fffbeb;
            color: #d97706;
            border: 1px solid #fed7aa;
        }

        .alert-item.info {
            background: #eff6ff;
            color: #2563eb;
            border: 1px solid #bfdbfe;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100px;
            color: var(--text-secondary);
        }

        .error {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100px;
            color: var(--danger-red);
            text-align: center;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .insights-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="analytics-container">
        <!-- Key Insights Section -->
        <div class="insights-section">
            <div class="section-title">
                üß† –ö–ª—é—á–µ–≤—ã–µ –∏–Ω—Å–∞–π—Ç—ã
            </div>
            <div class="insights-grid" id="insightsGrid">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Å–∞–π—Ç–æ–≤...</div>
            </div>
        </div>

        <!-- Recommendations Section -->
        <div class="insights-section">
            <div class="section-title">
                üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
            </div>
            <div class="recommendations-list" id="recommendationsList">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π...</div>
            </div>
        </div>

        <!-- Alerts Section -->
        <div class="insights-section">
            <div class="section-title">
                ‚ö†Ô∏è –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –∞–ª–µ—Ä—Ç—ã
            </div>
            <div class="alerts-list" id="alertsList">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...</div>
            </div>
        </div>
    </div>

    <script>
        class AnalyticsServiceV2 {
            constructor() {
                this.currentPeriod = '2024-12';
                this.analyticsData = null;
                this.allowedOrigin = location.origin;
                this.apiBase = 'enhanced-coordinator-v2.php';
                
                this.init();
            }

            init() {
                console.log('üß† Analytics Service v2.1: Initializing...');
                
                this.setupMessageHandling();
                this.loadAnalyticsData();
                
                // –£–≤–µ–¥–æ–º–ª—è–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ –æ–∫–Ω–æ –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
                this.notifyParent('service_ready', {
                    service: 'analytics',
                    version: '2.1.0',
                    capabilities: ['insights', 'recommendations', 'alerts', 'trend_analysis', 'performance_monitoring']
                });
                
                console.log('üß† Analytics Service v2.1: Ready');
            }

            setupMessageHandling() {
                window.addEventListener('message', (event) => {
                    if (event.origin !== this.allowedOrigin) {
                        console.warn('üß† Analytics: Blocked message from untrusted origin:', event.origin);
                        return;
                    }
                    
                    const { type, payload } = event.data || {};
                    
                    switch (type) {
                        case 'filters_changed':
                            this.handleFiltersChanged(payload);
                            break;
                            
                        default:
                            console.log('üß† Analytics: Unknown message type:', type);
                    }
                });
            }

            async fetchJson(url, timeoutMs = 5000) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
                
                try {
                    const response = await fetch(url, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    clearTimeout(timeoutId);
                    throw error;
                }
            }

            async loadAnalyticsData() {
                try {
                    console.log('üß† Analytics: Loading data for period', this.currentPeriod);
                    
                    const data = await this.fetchJson(`${this.apiBase}?action=analytics&month=${this.currentPeriod}`);
                    
                    if (!data.ok) {
                        throw new Error(data.error || 'API returned error');
                    }
                    
                    this.analyticsData = data;
                    this.renderInsights();
                    this.renderRecommendations();
                    this.renderAlerts();
                    
                    // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö
                    this.notifyParent('data_updated', {
                        service: 'analytics',
                        data: data,
                        period: this.currentPeriod
                    });
                    
                    console.log('üß† Analytics: Data loaded successfully', data);
                    
                } catch (error) {
                    console.error('üß† Analytics: Failed to load data', error);
                    this.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
                }
            }

            renderInsights() {
                const { insights } = this.analyticsData;
                const container = document.getElementById('insightsGrid');
                
                container.innerHTML = insights.map(insight => `
                    <div class="insight-card ${insight.type}">
                        <div class="insight-title">
                            ${insight.icon} ${insight.title}
                        </div>
                        <div class="insight-description">
                            ${insight.description}
                        </div>
                    </div>
                `).join('');
            }

            renderRecommendations() {
                const { recommendations } = this.analyticsData;
                const container = document.getElementById('recommendationsList');
                
                container.innerHTML = recommendations.map(rec => `
                    <div class="recommendation-item">
                        <div class="recommendation-icon ${rec.category}">
                            ${rec.icon}
                        </div>
                        <div class="recommendation-content">
                            <div class="recommendation-title">${rec.title}</div>
                            <div class="recommendation-description">${rec.description}</div>
                        </div>
                    </div>
                `).join('');
            }

            renderAlerts() {
                const { alerts } = this.analyticsData;
                const container = document.getElementById('alertsList');
                
                if (alerts.length === 0) {
                    container.innerHTML = `
                        <div class="alert-item info">
                            ‚úÖ –í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = alerts.map(alert => `
                    <div class="alert-item ${alert.severity}">
                        ${alert.icon} ${alert.message}
                    </div>
                `).join('');
            }

            handleFiltersChanged(payload) {
                const { month } = payload;
                
                if (month !== this.currentPeriod) {
                    console.log('üß† Analytics: Period changed to', month);
                    this.currentPeriod = month;
                    this.loadAnalyticsData();
                }
            }

            showError(message) {
                document.getElementById('insightsGrid').innerHTML = `<div class="error">${message}</div>`;
                document.getElementById('recommendationsList').innerHTML = `<div class="error">${message}</div>`;
                document.getElementById('alertsList').innerHTML = `<div class="error">${message}</div>`;
            }

            notifyParent(type, payload) {
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({ type, payload }, this.allowedOrigin);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new AnalyticsServiceV2();
        });
    </script>
</body>
</html>
